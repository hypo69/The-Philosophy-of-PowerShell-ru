

### **Управление "Историей файлов" Windows с помощью PowerShell**

"История файлов" (File History) — это встроенный в Windows механизм для непрерывного резервного копирования версий файлов. Он автоматически сканирует личные папки пользователя и сохраняет измененные файлы на внешний носитель, создавая хронологию версий. Это позволяет восстанавливать предыдущие состояния файлов или возвращать случайно удаленные данные.

Хотя основной интерфейс управления "Историей файлов" является графическим, PowerShell предоставляет полный набор инструментов для автоматизации настройки и управления этим функционалом через командную строку, используя модуль `FileHistory`.

#### 1. Проверка текущего состояния

Перед выполнением любых действий необходимо получить текущую конфигурацию и статус службы.

*   `Get-FhConfiguration`: Возвращает основные параметры: включена ли служба, какой диск используется в качестве цели, частота резервного копирования и срок хранения версий.
*   `Get-FhStatus`: Показывает операционный статус, включая время последнего успешного копирования и текущее состояние (например, `Idle`, `Running`).

```powershell
# Пример проверки конфигурации
Get-FhConfiguration

# Пример проверки статуса
Get-FhStatus
```

#### 2. Настройка и включение

Процесс активации состоит из двух шагов: выбор целевого диска и включение службы.

```powershell
# 1. Найти подходящие диски (не системные)
$drives = Get-Volume | Where-Object { $_.DriveType -eq 'Fixed' -and $_.DriveLetter -ne 'C' }

if ($drives) {
    # 2. Интерактивно выбрать один диск (пример с Out-ConsoleGridView)
    $targetDrive = $drives | Out-ConsoleGridView -Title "Выберите диск для Истории файлов"

    if ($targetDrive) {
        # 3. Назначить выбранный диск как целевой
        Set-FhTarget -Target $targetDrive
        
        # 4. Включить Историю файлов
        Set-FhConfiguration -Enabled $true
        
        Write-Host "История файлов включена. Целевой диск: $($targetDrive.Path)" -ForegroundColor Green
    }
} else {
    Write-Warning "Подходящие внешние диски не найдены."
}
```

#### 3. Изменение параметров резервного копирования

Командлет `Set-FhConfiguration` позволяет управлять ключевыми параметрами.

*   **`-Frequency`**: Устанавливает частоту копирования в минутах.
*   **`-RetentionAge`**: Определяет срок хранения версий в месяцах.

```powershell
# Установить частоту копирования на 6 часов (360 минут)
Set-FhConfiguration -Frequency 360

# Установить срок хранения версий на 6 месяцев.
# Возможные значения: 0 (Forever), 1, 2, 3, 6, 9, 12, 24.
Set-FhConfiguration -RetentionAge 6
```

#### 4. Управление защищаемыми и исключенными папками

Вы можете добавлять или удалять папки из области действия "Истории файлов".

*   `Get-FhProtectedFolders`: Показывает список папок, которые отслеживаются.
*   `Add-FhExcludedFolder`: Исключает папку из резервного копирования.
*   `Remove-FhExcludedFolder`: Возвращает исключенную папку в область отслеживания.

```powershell
# Посмотреть, какие папки сейчас защищены
Get-FhProtectedFolders

# Исключить папку "Загрузки" из бэкапа, чтобы сэкономить место
$downloadsPath = [System.Environment]::GetFolderPath('Downloads')
Add-FhExcludedFolder -Path $downloadsPath

# Вернуть папку "Загрузки" обратно в бэкап
Remove-FhExcludedFolder -Path $downloadsPath
```

#### 5. Запуск резервного копирования вручную

Командлет `Start-FhBackup` позволяет инициировать цикл резервного копирования немедленно, не дожидаясь расписания.

```powershell
# Запустить стандартный бэкап в фоновом режиме
Start-FhBackup

# Запустить бэкап с возможностью взаимодействия с пользователем (например, если диск отключен)
Start-FhBackup -AllowUserInteraction
```

#### 6. Отключение "Истории файлов"

Для временной или постоянной остановки службы используется `Set-FhConfiguration`.

```powershell
Set-FhConfiguration -Enabled $false
Write-Host "История файлов отключена."
```

#### 7. Диагностика и решение проблем с помощью журнала событий

Если "История файлов" работает со сбоями, PowerShell является основным инструментом для анализа причин. Все ошибки и предупреждения службы записываются в специальный журнал событий, который можно эффективно анализировать с помощью `Get-WinEvent`.

**Сценарий:** Вы заметили, что резервное копирование не выполняется, а в "Просмотрщике событий" по пути `Журналы приложений и служб -> Microsoft -> Windows -> FileHistory-Engine -> Журнал архивации истории файлов` видите множество ошибок с кодом `100`. Детальный анализ одной из них показывает причину:
> Файл не архивирован, так как его полный путь превышает предел MAX_PATH или содержит неподдерживаемые символы.

Это одна из самых частых проблем "Истории файлов", особенно для разработчиков или пользователей, хранящих сложные структуры папок, так как некоторые системные API имеют ограничение на максимальную длину пути.

**Задача:** Найти все файлы, которые "История файлов" пропускает из-за этой проблемы. С помощью PowerShell мы можем прочитать весь журнал ошибок и извлечь из него пути к проблемным файлам.

```powershell
# Название журнала событий "Истории файлов"
$logName = 'Microsoft-Windows-FileHistory-Engine/File History Backup Log'

# Получаем все события с кодом ошибки 100 (Проблема с файлом)
$pathErrors = Get-WinEvent -FilterHashtable @{LogName=$logName; Id=100}

# Если ошибки найдены, извлекаем из них пути к файлам
if ($pathErrors) {
    # Свойство Message содержит текст ошибки. Мы извлекаем из него путь к файлу,
    # который обычно находится на второй строке сообщения.
    $problematicFiles = $pathErrors | ForEach-Object {
        $messageLines = $_.Message -split [System.Environment]::NewLine
        # Убеждаемся, что в сообщении есть вторая строка (путь к файлу)
        if ($messageLines.Count -ge 2) {
            $messageLines[1].Trim()
        }
    }

    # Выводим уникальный список проблемных файлов в интерактивную таблицу
    $problematicFiles | Get-Unique | Out-ConsoleGridView -Title "Файлы, пропущенные Историей файлов (длинный путь)"
} else {
    Write-Host "Ошибок с кодом 100 в журнале 'Истории файлов' не найдено." -ForegroundColor Green
}
```

**Анализ и решение:**
1.  **Запустите скрипт:** Он проанализирует журнал и покажет вам в `Out-ConsoleGridView` список всех файлов, которые не удалось скопировать.
2.  **Изучите список:** Вы увидите файлы с очень длинными именами или находящиеся в глубоко вложенных папках.
3.  **Примите решение:** Основываясь на этом списке, вы можете:
    *   **Переименовать/переместить файлы:** Сократить длину пути, чтобы "История файлов" могла их обработать.
    *   **Исключить родительскую папку:** Если все проблемные файлы находятся в одной папке (например, `node_modules`), проще исключить всю эту папку из резервного копирования с помощью `Add-FhExcludedFolder`.

**Пример исключения проблемной папки:**
```powershell
# Предположим, анализ показал, что все проблемы в папке 'C:\Users\user\Documents\repos\hypotez'
$problemFolder = 'C:\Users\user\Documents\repos\hypotez'

# Исключаем ее из бэкапа
Add-FhExcludedFolder -Path $problemFolder

Write-Host "Папка '$problemFolder' была исключена из Истории файлов." -ForegroundColor Yellow
```

Таким образом, PowerShell позволяет не просто увидеть факт наличия ошибки, а **извлечь из журнала конкретные данные** (пути к файлам), проанализировать их и принять меры для устранения проблемы.

#### Восстановление файлов

Восстановление файлов выполняется через графический интерфейс. Запустить его можно из окна **"Панель управления"** -> **"История файлов"**, нажав на ссылку **"Восстановление личных файлов"**.

#### Итог

Модуль `FileHistory` в PowerShell предоставляет администраторам и продвинутым пользователям полный контроль над функционалом "Истории файлов". Это позволяет автоматизировать настройку, проводить глубокую диагностику и интегрировать этот инструмент в общую стратегию управления системой.