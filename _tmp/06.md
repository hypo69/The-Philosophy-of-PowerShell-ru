
### **Часть 6: Основы скриптинга. Файлы `.ps1` и политика выполнения.**

До сих пор мы вводили команды непосредственно в консоль. Это идеально подходит для быстрых проверок, исследования системы и выполнения разовых задач. Но что, если нам нужно выполнить сложную последовательность из десятков команд, да еще и делать это регулярно? Заново вбивать все вручную каждый раз — неэффективно и чревато ошибками. Здесь на сцену выходит **скриптинг**.

#### **Переход от интерактивной консоли к написанию скриптов**

Скрипт в PowerShell — это обычный текстовый файл, который содержит одну или несколько команд. По соглашению, такие файлы имеют расширение **`.ps1`**. Когда вы запускаете такой файл, PowerShell выполняет содержащиеся в нем команды последовательно, сверху вниз.

**Какой редактор использовать?**
Вы можете создавать `.ps1` файлы в любом текстовом редакторе, даже в "Блокноте". Однако для комфортной и эффективной работы настоятельно рекомендуется использовать редакторы, которые "понимают" синтаксис PowerShell:

1.  **Visual Studio Code (VS Code):** Это текущий де-факто стандарт для разработки на PowerShell. С установленным официальным расширением **PowerShell** от Microsoft, VS Code предоставляет подсветку синтаксиса, интеллектуальное автодополнение (IntelliSense), встроенную консоль, отладчик и множество других полезных функций.
2.  **Windows PowerShell ISE:** Классическая интегрированная среда сценариев, которая поставляется вместе с Windows PowerShell (версии 5.1 и ниже). Она все еще функциональна и удобна для новичков, но больше активно не развивается Microsoft.

#### **Создание и запуск вашего первого `.ps1` файла**

Давайте создадим наш первый простой скрипт.

**Практика:**

1.  Откройте VS Code (или любой другой редактор).
2.  Создайте новый файл.
3.  Вставьте в него следующий код:

    ```powershell
    # MyFirstScript.ps1
    # Этот скрипт выводит приветствие и показывает 3 самых ресурсоемких процесса.

    # Выводим приветственное сообщение
    Write-Host "--- Мониторинг системы запущен ---" -ForegroundColor Green

    # Получаем имя текущего пользователя и компьютера
    $currentUser = $env:USERNAME
    $computerName = $env:COMPUTERNAME
    Write-Host "Скрипт запущен пользователем '$currentUser' на компьютере '$computerName'."

    # Получаем текущую дату и время
    $currentDate = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "Текущее время: $currentDate"

    Write-Host "" # Пустая строка для разделения

    # Находим и выводим 3 процесса, которые больше всего используют процессор
    Write-Host "Топ-3 процессов по загрузке CPU:"
    Get-Process | Sort-Object -Property CPU -Descending | Select-Object -First 3 -Property ProcessName, Id, CPU

    Write-Host "--- Мониторинг завершен ---"
    ```
4.  Сохраните файл под именем `MyFirstScript.ps1` в удобную для вас папку (например, `C:\Scripts`).

**Как запустить скрипт?**

Откройте консоль PowerShell, перейдите в папку, где вы сохранили скрипт, и попробуйте его запустить:

```powershell
# Переходим в нужную папку
Set-Location C:\Scripts

# Запускаем скрипт
.\MyFirstScript.ps1
```
**Важный синтаксис:** Для запуска скрипта в текущей директории необходимо явно указать путь к нему. Просто написать `MyFirstScript.ps1` (как в `cmd.exe`) не сработает. Это сделано в целях безопасности. `.\` означает "в текущей директории".

При попытке запуска вы, скорее всего, столкнетесь с красной ошибкой...

#### **Политики выполнения (Execution Policy): "Охранник" PowerShell**

...и эта ошибка будет связана с политикой выполнения.

**Политика выполнения** — это встроенный в PowerShell механизм безопасности, который определяет, можно ли запускать скрипты на данном компьютере и какие требования к ним предъявляются. Это не "непробиваемая стена", а скорее "предохранитель", который защищает неопытных пользователей от случайного запуска вредоносных скриптов.

**Практика: Проверка и изменение политики**

1.  **Узнаем текущую политику:**

    ```powershell
    Get-ExecutionPolicy
    ```
    Скорее всего, результат будет `Restricted`.

2.  **Основные уровни политики:**

    | Уровень | Описание |
    | :--- | :--- |
    | `Restricted` | **(По умолчанию на клиентских ОС)**. Запуск любых скриптов запрещен. PowerShell можно использовать только в интерактивном режиме. |
    | `AllSigned` | Можно запускать только те скрипты, которые подписаны доверенным издателем с помощью цифровой подписи. |
    | `RemoteSigned`| **(Рекомендуемый уровень для рабочих станций и по умолчанию на серверах)**. Локально созданные вами скрипты можно запускать. Скрипты, скачанные из интернета, должны быть подписаны цифровой подписью. |
    | `Unrestricted`| Можно запускать любые скрипты без ограничений. Не рекомендуется использовать этот уровень без веской причины. |
    | `Bypass` | Ничего не блокируется и никакие предупреждения не выводятся. Обычно используется для временного запуска в автоматизированных системах. |

3.  **Устанавливаем безопасную политику:**
    Для нашей учебной и рабочей среды самой подходящей является `RemoteSigned`. Чтобы ее установить, нужно запустить PowerShell **от имени администратора** и выполнить команду:

    ```powershell
    Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
    ```
    *   `-Scope CurrentUser`: Этот важный параметр устанавливает политику только для вашего текущего пользователя, не затрагивая настройки для всей системы. Это более безопасно и часто не требует прав администратора.

    PowerShell задаст вопрос для подтверждения. Нажмите `Y` и `Enter`.

4.  **Снова запускаем наш скрипт:**
    Теперь, когда политика установлена, вернитесь в обычную консоль (не от администратора) и снова попробуйте запустить скрипт:

    ```powershell
    .\MyFirstScript.ps1
    ```
    На этот раз все должно сработать, и вы увидите результат работы вашего первого сценария!

**Итог главы:**
Вы совершили ключевой переход от интерактивной консоли к созданию и выполнению скриптов. Вы узнали, что такое `.ps1` файлы и какие редакторы лучше использовать для работы с ними. Самое главное, вы разобрались с фундаментальной концепцией безопасности PowerShell — политиками выполнения, научились проверять и устанавливать их, открыв себе дорогу для запуска любых ваших будущих сценариев автоматизации.

**В следующей части мы начнем наполнять наши скрипты логикой, изучив условные конструкции (`If/Else`) и циклы (`ForEach`, `For`, `While`).**