### **Часть 10: Модули и PowerShell Gallery.**

В предыдущих главах мы научились писать функции, которые инкапсулируют полезную логику. Но где их хранить? Можно, конечно, держать все в одном гигантском `.ps1` файле и копировать его из проекта в проект, но это путь к хаосу. Правильный, "PowerShell-way" подход — это организация кода в **модули**.

Модуль в PowerShell — это не просто набор функций. Это самодостаточный, переиспользуемый пакет, который может содержать функции, переменные, классы, файлы форматирования, файлы типов и многое другое. Модули — это строительные блоки, из которых состоит современная экосистема PowerShell.

#### **Что такое модуль и зачем он нужен?**

Представьте, что вы написали 15 функций для работы с Active Directory. Вы можете объединить их в модуль под названием, например, `MyADUtils`. После этого любой другой пользователь (или вы сами в другом скрипте) сможет просто импортировать этот модуль и сразу же получить доступ ко всем вашим 15 функциям, как если бы они были встроенными в PowerShell.

**Преимущества модульного подхода:**

*   **Организация:** Код логически сгруппирован. Все, что относится к работе с AD, лежит в одном месте.
*   **Переиспользование:** Вы можете использовать свой модуль в неограниченном количестве скриптов, не дублируя код.
*   **Инкапсуляция и сокрытие:** Модуль позволяет сделать некоторые функции "приватными" (внутренними), а наружу "выставить" только те, что предназначены для конечного пользователя.
*   **Управление версиями:** Вы можете версионировать свой модуль (v1.0, v1.1, v2.0), что позволяет безопасно вносить изменения.
*   **Распространение:** Упакованный модуль легко передать коллеге или опубликовать для всего мира.

#### **Анатомия модуля: `.psm1` и `.psd1`**

В самом простом виде модуль — это всего лишь один файл с расширением **`.psm1` (PowerShell Script Module)**. Это обычный скрипт PowerShell, содержащий ваши функции.

Однако для профессионального модуля всегда создается и второй файл — **манифест модуля** с расширением **`.psd1` (PowerShell Data File)**. Это текстовый файл, содержащий метаданные о вашем модуле в формате хеш-таблицы PowerShell.

**Давайте создадим наш первый модуль `MyLogUtils` на основе наработок из предыдущих глав.**

**Шаг 1: Создание структуры папок**
Правильная практика — хранить модуль в папке, имя которой совпадает с именем модуля.

```
C:\Scripts\Modules\
└── MyLogUtils\
    ├── MyLogUtils.psm1
    └── MyLogUtils.psd1
```

**Шаг 2: Создание файла `.psm1`**
В файл `MyLogUtils.psm1` мы поместим наши функции. Обратите внимание на использование `Export-ModuleMember`.

```powershell
# Файл: MyLogUtils.psm1

# Это "приватная" вспомогательная функция.
# Она не будет экспортирована и видна пользователю модуля.
function Get-FormattedTimestamp {
    return "[{0}]" -f (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
}

# Это "публичная" функция, которую мы хотим предоставить пользователю.
function Write-MyLog {
    param (
        [string]$Message,
        [string]$Level = "INFO"
    )
    $timestamp = Get-FormattedTimestamp
    $logEntry = "$timestamp [$Level] - $Message"
    Add-Content -Path "C:\Temp\app.log" -Value $logEntry
}

# Явно указываем, какие функции мы экспортируем из модуля.
# Все остальные функции останутся внутренними.
Export-ModuleMember -Function Write-MyLog
```

**Шаг 3: Создание манифеста `.psd1`**
Манифест — это "паспорт" вашего модуля. Его можно создать вручную, но проще всего сгенерировать с помощью командлета `New-ModuleManifest`.

```powershell
# Выполните эту команду в папке C:\Scripts\Modules\MyLogUtils\
New-ModuleManifest -Path .\MyLogUtils.psd1 -RootModule .\MyLogUtils.psm1 -Author "Your Name" -Description "Простой модуль для логирования." -PowerShellVersion "5.1"
```
Эта команда создаст файл `MyLogUtils.psd1` с множеством полей. Самые важные из них:
*   `RootModule = 'MyLogUtils.psm1'`: Указывает на главный файл модуля.
*   `ModuleVersion = '1.0.0'`: Версия вашего модуля. Очень важна для обновления.
*   `FunctionsToExport = @('Write-MyLog')`: Список функций, которые будут экспортированы. Можно оставить `'*'` для экспорта всех, но явное указание — лучшая практика.
*   `Author`, `Description`: Метаданные.

#### **Импорт и использование команд из модуля: `Import-Module`**

Теперь, когда модуль создан, как его использовать?

1.  **Поиск и автозагрузка:** PowerShell автоматически ищет модули в папках, перечисленных в переменной окружения `$env:PSModulePath`. Вы можете добавить `C:\Scripts\Modules` в эту переменную, и тогда PowerShell будет находить ваш модуль автоматически.
2.  **Явный импорт:** Самый надежный способ — явно импортировать модуль по пути к его манифесту.

    ```powershell
    Import-Module -Path C:\Scripts\Modules\MyLogUtils\MyLogUtils.psd1 -Force
    # -Force полезен при разработке для переимпортирования измененного модуля

    # Теперь наша функция доступна как обычный командлет
    Write-MyLog -Message "Модуль успешно импортирован!"
    ```
3.  **Проверка загруженных команд:**
    ```powershell
    Get-Command -Module MyLogUtils
    ```
    Эта команда покажет все команды, которые экспортирует ваш модуль.

#### **PowerShell Gallery: Глобальная библиотека модулей**

Держать модули локально — хорошо, но что если вы хотите поделиться своим творением со всем миром или, наоборот, использовать наработки тысяч других разработчиков? Для этого существует **PowerShell Gallery (PSGallery)**. Это официальный публичный репозиторий модулей, управляемый Microsoft.

*   **`Find-Module`**: Ищет модуль в галерее.
    **Практика:** Давайте найдем популярный модуль для работы с иконками и уведомлениями.

    ```powershell
    Find-Module -Name "BurntToast"
    ```
*   **`Install-Module`**: Скачивает и устанавливает модуль из галереи в одну из папок `$env:PSModulePath`.

    ```powershell
    # PowerShell может запросить подтверждение на установку из "недоверенного" репозитория.
    # Это нормально для PSGallery.
    Install-Module -Name "BurntToast" -Scope CurrentUser
    # -Scope CurrentUser устанавливает модуль только для вас и не требует прав администратора.
    ```
*   **`Update-Module`**: Проверяет, есть ли в галерее новая версия установленного модуля, и обновляет его.
*   **`Publish-Module`**: Позволяет опубликовать ваш собственный модуль в PowerShell Gallery (требует регистрации и получения API-ключа).

.

**В следующей, заключительной перед проектом, главе мы выйдем за пределы одного компьютера и освоим инструменты удаленного управления и выполнения фоновых задач.**