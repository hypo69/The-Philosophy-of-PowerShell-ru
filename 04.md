# Философия PowerShell.

### **Часть 4: Интерактивная работа: `Out-ConsoleGridView`, `F7History` и `ConsoleGuiTools`**

#### **Историческая справка: F7 и `Out-GridView`**



Прежде чем двигаться вперед, давайте на мгновение оглянемся назад.
*   **Командлет `Out-GridView`**
    Это был значительный шаг для своего времени. `Out-GridView` позволял взять любой вывод из конвейера и отобразить его в отдельном графическом окне с возможностью сортировки и, что самое главное, с мгновенной фильтрацией.

    ```powershell
    # Классический пример
    Get-Process | Out-GridView
    ```

    Но у него было два недостатка:
    1.  Он вырывал вас из контекста консоли, открывая отдельное GUI-окно.
    2.  Он зависел от графической подсистемы Windows и не работал в "чистой" консоли, например, через SSH или в Windows Server Core.


#### **Инструмент №1: `Out-ConsoleGridView` — `Out-GridView` для терминала**

Это современная замена классическому `Out-GridView`, которая работает прямо внутри вашей консоли. Она решает обе проблемы своего предшественника: не открывает новых окон и работает везде, где есть PowerShell 7.2+, включая SSH-сессии.

**❗ Важно:** Все описываемые ниже инструменты требуют **PowerShell 7.2 или новее**.

`Out-ConsoleGridView` является частью модуля `Microsoft.PowerShell.ConsoleGuiTools`. Для его использования сначала нужно установить этот модуль:

```powershell
Install-Module Microsoft.PowerShell.ConsoleGuiTools -Scope CurrentUser
```
![1](assets/04/1.png)
После установки вы можете передавать любой вывод в `Out-ConsoleGridView` для интерактивной работы.

**Возможности интерфейса:**
*   **Фильтрация:** Просто начните вводить текст, и список будет отфильтрован на лету.
*   **Навигация:** Используйте клавиши-стрелки для перемещения по списку.
*   **Выбор:** Нажмите `Space` для выбора/снятия выделения с одного элемента.
*   **Множественный выбор:** `Ctrl+A` для выбора всех элементов, `Ctrl+D` для снятия всего выделения.
*   **Подтверждение:** Нажмите `Enter`, чтобы вернуть выбранные объекты.
*   **Отмена:** Нажмите `ESC`, чтобы закрыть окно без возврата данных.

**Примеры использования:**

1.  **Интерактивное управление процессами:**
    Вы можете выбрать несколько процессов для остановки. Параметр `-OutputMode Multiple` указывает, что мы хотим вернуть все выбранные элементы.

    ```powershell
    # Выбираем процессы в интерактивном режиме
    $procsToStop = Get-Process | Out-ConsoleGridView -OutputMode Multiple
    
    # Если что-то было выбрано, передаем объекты дальше по конвейеру
    if ($procsToStop) {
        $procsToStop | Stop-Process -WhatIf
    }
    ```

2.  **Выбор файлов для архивации:**
    Найдем все `.log` файлы в папке, выберем нужные и создадим из них архив.

    ```powershell
    $filesToArchive = Get-ChildItem -Path C:\Logs -Filter "*.log" -Recurse | Out-ConsoleGridView -OutputMode Multiple
    
    if ($filesToArchive) {
        Compress-Archive -Path $filesToArchive.FullName -DestinationPath C:\Temp\LogArchive.zip
    }
    ```

3.  **Выбор одного элемента для детального анализа:**
    `Out-ConsoleGridView` по умолчанию возвращает один объект (`-OutputMode Single`), что удобно для выбора одного элемента и его детального изучения.

    ```powershell
    # Выбираем один сетевой адаптер
    $adapter = Get-NetAdapter | Out-ConsoleGridView
    
    # Если адаптер был выбран, получаем его полную IP-конфигурацию
    if ($adapter) {
        Get-NetIPConfiguration -InterfaceIndex $adapter.InterfaceIndex
    }
    ```

---


*   **Клавиша `F7` в `cmd.exe`**
    Если вы застали эпоху `cmd.exe` (или даже `COMMAND.COM`), вы, возможно, помните эту клавишу. 
    Нажатие `F7` вызывало простое текстовое меню с историей ваших команд. 
    Можно было стрелками выбрать нужную и нажать `Enter`. Это было быстро и просто, но очень аскетично: 
    никакой фильтрации, никакой дополнительной информации. В PowerShell эта функция исчезла, уступив место прокрутке стрелками.



#### **Инструмент №2: `F7History` — История команд на новом уровне**

Этот модуль возвращает функциональность клавиши `F7`, но использует современный интерфейс `ConsoleGuiTools`, предоставляя мощные возможности поиска по истории команд.

**Установка внешнего модуля на примере `F7History`**

1.  **Выполните команду установки:**
    ```powershell
    Install-Module F7History -Scope CurrentUser
    ```

2.  **Диалог о NuGet (если появляется):**
    При первой установке модуля из PowerShell Gallery система может запросить установку провайдера `NuGet`.
    ```
    NuGet provider is required to continue
    ...
    Do you want PowerShellGet to install and import the NuGet provider now?
    [Y] Yes [N] No [S] Suspend [?] Help (default is “Y”):
    ```
    **Что это?** `NuGet` — это стандартный менеджер пакетов для платформы .NET. `PowerShellGet` использует его для скачивания и установки модулей. **На этот запрос следует отвечать `Y` (Да).**

3.  **Диалог о недоверенном репозитории:**
    Далее вы увидите предупреждение о том, что PSGallery является "недоверенным" репозиторием.
    ```
    Untrusted repository
    ...
    Are you sure you want to install the modules from 'PSGallery'?
    [Y] Yes [A] Yes to All [N] No [L] No to All [?] Help (default is “N”):
    ```
    **Что это?** Это стандартная мера предосторожности. По умолчанию PowerShell доверяет только внутренним, корпоративным репозиториям. PowerShell Gallery, хоть и управляется Microsoft, считается внешним. **На этот запрос безопасно отвечать `Y` (Да) или `A` (Да для всех в текущей сессии).**

4.  **Настройка для постоянного использования:**
    Чтобы `F7History` работал в каждой новой сессии PowerShell, добавьте его в свой файл профиля:
    ```powershell
    # Добавляет команду импорта в конец файла профиля
    Add-Content -Path $PROFILE -Value "Import-Module F7History"
    ```
    Перезапустите PowerShell, чтобы изменения вступили в силу.

**Полное описание опций `F7History`**

*   **`F7` — История текущей сессии:**
    При нажатии `F7` открывается окно с историей команд, выполненных только в **текущем** окне PowerShell. Это полезно для быстрого поиска и повторения недавних действий.

*   **`Shift+F7` — Глобальная история:**
    Это более мощный режим. Он показывает **объединенную историю команд из всех сессий PowerShell**, которые когда-либо запускались под вашим пользователем. Каждая команда сопровождается **точной датой и временем** выполнения. Этот режим незаменим для того, чтобы вспомнить, как вы решали какую-то задачу неделю или месяц назад.

---

#### **Технология в основе: `Microsoft.PowerShell.ConsoleGuiTools`**

В заключение важно понять, что оба рассмотренных инструмента, `Out-ConsoleGridView` и `F7History`, являются не отдельными приложениями, а надстройками над единым фундаментом — модулем `Microsoft.PowerShell.ConsoleGuiTools`.

Это официальная библиотека от Microsoft, которая предоставляет разработчикам набор инструментов для создания псевдографических интерфейсов в терминале. Именно она отвечает за отрисовку окон, таблиц, обработку нажатий клавиш и создание интерактивных элементов. Благодаря этому модулю сообщество может создавать все более сложные и удобные консольные утилиты, которые будут работать кросс-платформенно.

**В следующей главе мы рассмотрим, как упаковывать наши собственные функции и скрипты в многоразовые модули.**